# PostgreSQL Upgrade Guide (14 ‚Üí 17)

This document provides a **step-by-step guide** to safely upgrade a PostgreSQL cluster from **version 14** to **version 17** using the `pg_upgrade` tool.  
It follows best practices and includes **dry-run validation** before performing the actual upgrade.

---

## üöÄ 1. Install PostgreSQL 14 & 17

Make sure both versions are installed on your system:

```bash
sudo apt update
sudo apt install postgresql-14 postgresql-17 -y
```

Verify installation:

```bash
pg_lsclusters
```

---

## üìÇ 2. Prepare the PostgreSQL 17 Cluster

If the PostgreSQL 17 cluster does **not** exist yet, create it manually:

```bash
sudo pg_createcluster 17 main --datadir=/var/lib/postgresql/17/main --start-conf=manual
sudo mkdir -p /var/lib/postgresql/17/main
sudo chown -R postgres:postgres /var/lib/postgresql/17
sudo -u postgres /usr/lib/postgresql/17/bin/initdb -D /var/lib/postgresql/17/main
```

---

## üõë 3. Stop PostgreSQL 14 Cluster

Before upgrade, stop the old cluster:

```bash
sudo pg_ctlcluster 14 main stop
```

---

## üîç 4. Run Dry-Run Check (Optional but Recommended)

Validate that upgrade is possible without making changes:

```bash
sudo -u postgres /usr/lib/postgresql/17/bin/pg_upgrade   -b /usr/lib/postgresql/14/bin   -B /usr/lib/postgresql/17/bin   -d /var/lib/postgresql/14/main   -D /var/lib/postgresql/17/main   -o "-c config_file=/etc/postgresql/14/main/postgresql.conf       -c hba_file=/etc/postgresql/14/main/pg_hba.conf       -c ident_file=/etc/postgresql/14/main/pg_ident.conf       -c shared_preload_libraries=''       -c listen_addresses=''       -c unix_socket_permissions=0700       -c unix_socket_directories='/tmp'"   -O "-c config_file=/etc/postgresql/17/main/postgresql.conf       -c hba_file=/etc/postgresql/17/main/pg_hba.conf       -c ident_file=/etc/postgresql/17/main/pg_ident.conf       -c shared_preload_libraries=''       -c listen_addresses=''       -c unix_socket_permissions=0700       -c unix_socket_directories='/tmp'"   --check
```

If everything is OK, proceed.

---

## ‚ö° 5. Perform the Actual Upgrade

Run with parallel jobs and hard links for speed and reduced space:

```bash
sudo -u postgres /usr/lib/postgresql/17/bin/pg_upgrade   -b /usr/lib/postgresql/14/bin   -B /usr/lib/postgresql/17/bin   -d /var/lib/postgresql/14/main   -D /var/lib/postgresql/17/main   -o "-c config_file=/etc/postgresql/14/main/postgresql.conf       -c hba_file=/etc/postgresql/14/main/pg_hba.conf       -c ident_file=/etc/postgresql/14/main/pg_ident.conf       -c shared_preload_libraries=''       -c listen_addresses=''       -c unix_socket_permissions=0700       -c unix_socket_directories='/tmp'"   -O "-c config_file=/etc/postgresql/17/main/postgresql.conf       -c hba_file=/etc/postgresql/17/main/pg_hba.conf       -c ident_file=/etc/postgresql/17/main/pg_ident.conf       -c shared_preload_libraries=''       -c listen_addresses=''       -c unix_socket_permissions=0700       -c unix_socket_directories='/tmp'"   -j "$(nproc)"   --link
```

---

## ‚ñ∂Ô∏è 6. Start PostgreSQL 17 Cluster

```bash
sudo pg_ctlcluster 17 main start
```

Check clusters:

```bash
pg_lsclusters
```

You should now see only version **17** running.

---

## üß™ 7. Post-Upgrade Steps

1. Run the `analyze_new_cluster.sh` script generated by `pg_upgrade`:
   ```bash
   sudo -u postgres ./analyze_new_cluster.sh
   ```
   This updates planner statistics.

2. When satisfied, remove the old cluster:
   ```bash
   sudo -u postgres ./delete_old_cluster.sh
   ```

---

## ‚úÖ 8. Verification

Connect and check:

```bash
psql -U postgres -d postgres -p 5433
```

(Replace port if necessary. Use `pg_lsclusters` output.)

Confirm version:

```sql
SELECT version();
```

You should see **PostgreSQL 17**.

---

## üõ†Ô∏è Troubleshooting

- **Permission denied** ‚Üí Ensure directories under `/var/lib/postgresql/17` are owned by `postgres:postgres`
- **Missing contrib modules** ‚Üí Install: `sudo apt install postgresql-contrib-17`
- **Large database upgrade issues** ‚Üí Consider running with `--link` to save space or without it if you need a copy
- **WAL mismatches** ‚Üí Ensure clusters are stopped before upgrade

---

## üéØ Summary

- Installed PostgreSQL 14 and 17 side-by-side  
- Created and initialized PostgreSQL 17 cluster  
- Stopped PostgreSQL 14  
- Performed **dry-run check**  
- Executed actual upgrade with `pg_upgrade`  
- Started PostgreSQL 17 and verified  

You are now running PostgreSQL **17** with your existing data migrated from **14**.
